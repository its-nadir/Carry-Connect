rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    // Carriers collection (trip listings)
    match /carriers/{carrierId} {
      allow read: if true; // Anyone can view carriers
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isOwner(resource.data.userId);
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
    }
    
    // Trips collection
    match /trips/{tripId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isOwner(resource.data.userId);
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
    }
    
    // Conversations collection
    match /conversations/{conversationId} {
      allow read: if isSignedIn() && 
                     request.auth.uid in resource.data.participants;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && 
                       request.auth.uid in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isSignedIn() && 
                       request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        allow create: if isSignedIn() && 
                         request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      }
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if true; // Anyone can read reviews
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isOwner(resource.data.reviewerId);
      allow delete: if isSignedIn() && isOwner(resource.data.reviewerId);
    }
    
    // Bookings collection
    match /bookings/{bookingId} {
      allow read: if isSignedIn() && 
                     (isOwner(resource.data.senderId) || 
                      isOwner(resource.data.carrierId));
      allow create: if isSignedIn();
      allow update: if isSignedIn() && 
                       (isOwner(resource.data.senderId) || 
                        isOwner(resource.data.carrierId));
    }
  }
}
//rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ──────────────────────────────
    // Helper functions (unchanged – perfect)
    // ───────────────────────────────
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // ──────────────────────────────
    // 1. Users collection – improved
    // ──────────────────────────────
    match /users/{userId} {
      // Improvement: allow read + write in one line (cleaner & same result)
      allow read, write: if isSignedIn() && isOwner(userId);
      // Original had separate create/update/delete – redundant
    }

    // ──────────────────────────────
    // 2. Carriers collection → REMOVED (biggest improvement)
    // ──────────────────────────────
    // You had a separate /carriers collection → completely unnecessary
    // All trip data now lives only in /trips → simpler, faster, cheaper
    // match /carriers/{carrierId} { ... }  ← DELETED

    // ──────────────────────────────
    // 3. Trips collection – heavily improved
    // ──────────────────────────────
    match /trips/{tripId} {
      allow read: if isSignedIn();                    // Good as-is
      allow create: if isSignedIn();                  // Anyone logged in can post a trip

      // BIG IMPROVEMENT: allow update only for carrier OR the person who booked
      allow update: if isSignedIn() && (
        isOwner(resource.data.carrierUid) ||                     // Carrier can edit
        (resource.data.bookedByUid != null && isOwner(resource.data.bookedByUid)) // Shipper can edit after booking
      );

      allow delete: if isSignedIn() && isOwner(resource.data.carrierUid); // Only carrier can delete

      // ───── Chat inside each trip (replaces your whole conversations collection) ─────
      match /messages/{messageId} {
        // Improvement: no expensive get() calls → just check parent trip
        allow read, create: if isSignedIn() && (
          isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data.carrierUid) ||
          (get(/databases/$(database)/documents/trips/$(tripId)).data.bookedByUid != null &&
           isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data.bookedByUid))
        );
      }
    }

    // ──────────────────────────────
    // 4. Conversations collection → REMOVED (huge win)
    // ──────────────────────────────
    // Entire block deleted – chat now lives inside each trip → atomic, real-time, cheaper
    // match /conversations/{conversationId} { ... }  ← DELETED

    // ──────────────────────────────
    // 5. Reviews collection – perfect, only tiny cleanup
    // ──────────────────────────────
    match /reviews/{reviewId} {
      allow read: if true;                                         // Public reviews = good for trust
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && isOwner(resource.data.reviewerUid);
    }

    // ──────────────────────────────
    // 6. Bookings collection → REMOVED (another huge win)
    // ──────────────────────────────
    // Booking info now stored directly inside the trip document
    // No need for separate collection → no race conditions, simpler queries
    // match /bookings/{bookingId} { ... }  ← DELETED
  }
}//

// i think the following code is better than the previous it only have afew changes//

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return request.auth.uid == uid; }

    match /users/{userId} {
      allow read, write: if isSignedIn() && isOwner(userId);
    }

    match /trips/{tripId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        isOwner(resource.data.carrierUid) ||
        (resource.data.bookedByUid != null && isOwner(resource.data.bookedByUid))
      );
      allow delete: if isSignedIn() && isOwner(resource.data.carrierUid);

      match /messages/{msgId} {
        allow read, create: if isSignedIn() && (
          isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data.carrierUid) ||
          (get(/databases/$(database)/documents/trips/$(tripId)).data.bookedByUid != null &&
           isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data.bookedByUid))
        );
      }
    }

    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && isOwner(resource.data.reviewerUid);
    }
  }
}
